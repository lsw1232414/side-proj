<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>온비드 공매물건 검색</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "맑은 고딕", Arial, sans-serif;
            background: #f5f6f8;
        }
        header {
            background: #2F5FD0;
            color: #fff;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header .logo {
            font-size: 20px;
            font-weight: bold;
        }
        header .nav-right a {
            color: #fff;
            margin-left: 12px;
            font-size: 13px;
            text-decoration: none;
        }

        .container {
            max-width: 1100px;
            margin: 24px auto 40px;
            padding: 0 16px;
        }

        .search-box {
            background: #fff;
            border-radius: 8px;
            padding: 16px 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            margin-bottom: 18px;
        }

        .search-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .search-row label {
            font-size: 13px;
            color: #555;
            margin-right: 4px;
        }

        .search-row input[type="text"],
        .search-row input[type="number"],
        .search-row select {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 13px;
        }

        .search-row input[type="number"] {
            width: 120px;
        }

        .search-row .keyword-input {
            flex: 1;
            min-width: 220px;
        }

        .btn-primary {
            background: #2F5FD0;
            border: 1px solid #2F5FD0;
            color: #fff;
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-outline {
            background: #fff;
            border: 1px solid #d1d5db;
            color: #333;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 6px;
        }

        /* ★ Sync 버튼 전용 스타일 */
        .btn-sync {
            background: #444;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }

        .summary-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }

        .sort-area select {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .list-wrapper {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .item-row {
            padding: 14px 18px;
            border-bottom: 1px solid #f1f3f5;
            display: flex;
            gap: 12px;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .thumb {
            width: 120px;
            height: 80px;
            background: #e5e7eb;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
        }

        .item-main {
            flex: 1;
        }

        .title-line {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .title-line .badge {
            display: inline-block;
            font-size: 11px;
            background: #EEF3FF;
            color: #2F5FD0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 4px;
        }

        .sub-line {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .addr-line {
            font-size: 12px;
            color: #444;
            margin-bottom: 4px;
        }

        .price-line {
            font-size: 13px;
            font-weight: bold;
            color: #111;
        }

        .price-line span.sub {
            font-size: 11px;
            color: #777;
            margin-left: 8px;
            font-weight: normal;
        }

        .empty-msg {
            padding: 40px 0;
            text-align: center;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">온비드 공매 – 부동산 검색</div>
    <div class="nav-right">
        <a href="/">홈</a>
        <a href="/swagger-ui.html">API 문서</a>
    </div>
</header>

<div class="container">

    <!-- 검색 박스 -->
    <div class="search-box">
        <div class="search-row">
            <label>지역</label>
            <input type="text" id="keyword" class="keyword-input" placeholder="예) 서울, 강남, 경기도 성남시">

            <label>대분류</label>
            <select id="cate1">
                <option value="">전체</option>
                <option value="토지">토지</option>
                <option value="주거용">주거용</option>
                <option value="상업용">상업용</option>
                <option value="공장/창고">공장/창고</option>
                <option value="기타">기타</option>
            </select>

            <label>감정가</label>
            <input type="number" id="minPrice" placeholder="최소">
            <span>~</span>
            <input type="number" id="maxPrice" placeholder="최대">

            <button class="btn-primary" onclick="search()">검색</button>
            <button class="btn-outline" onclick="resetSearch()">초기화</button>

            <!-- ★★★★★ 여기 추가됨: SYNC 버튼 ★★★★★ -->
            <button class="btn-sync" onclick="syncData()">동기화</button>
        </div>
    </div>

    <!-- 결과 요약 -->
    <div class="summary-bar">
        <div class="result-count">
            총 <strong id="resultCount">0</strong>건 검색됨
        </div>
        <div class="sort-area">
            <select id="sortSelect" onchange="sortList()">
                <option value="recent">최신순</option>
                <option value="priceAsc">감정가 낮은순</option>
                <option value="priceDesc">감정가 높은순</option>
            </select>
        </div>
    </div>

    <!-- 결과 리스트 -->
    <div class="list-wrapper" id="resultWrapper">
        <div class="empty-msg">검색 조건을 입력하거나 “검색” 버튼을 눌러주세요.</div>
    </div>
</div>

<script>

    /* ========================
         ★ SYNC FUNCTION ★
       ======================== */
    function syncData() {
        if (!confirm("실시간 공매 데이터를 API에서 불러와 DB를 최신화합니다.\n시간이 다소 소요될 수 있습니다.\n진행할까요?")) {
            return;
        }

        const btn = document.querySelector(".btn-sync");
        btn.disabled = true;
        btn.textContent = "동기화 중...";

        fetch("/onbid/api/sync", { method: "POST" })
            .then(r => r.text())
            .then(msg => {
                alert("동기화 완료!");
                location.reload();
            })
            .catch(e => alert("오류 발생: " + e))
            .finally(() => {
                btn.disabled = false;
                btn.textContent = "동기화";
            });
    }

    /* 이하 기존 검색 JS ------------------------------------ */

    let currentData = [];

    function numberFormat(num) {
        if (num === null || num === undefined) return "-";
        return num.toLocaleString();
    }

    function fetchData(params = "") {
        return fetch("/onbid/api/search" + params)
            .then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            });
    }

    function search() {
        const keyword = document.getElementById("keyword").value.trim();
        const cate1 = document.getElementById("cate1").value;
        const minPrice = document.getElementById("minPrice").value;
        const maxPrice = document.getElementById("maxPrice").value;

        const q = [];
        if (keyword) q.push("keyword=" + encodeURIComponent(keyword));
        if (cate1) q.push("cate1=" + encodeURIComponent(cate1));
        if (minPrice) q.push("minPrice=" + encodeURIComponent(minPrice));
        if (maxPrice) q.push("maxPrice=" + encodeURIComponent(maxPrice));

        const paramStr = q.length > 0 ? "?" + q.join("&") : "";

        fetchData(paramStr)
            .then(list => {
                currentData = list || [];
                applySortAndRender();
            })
            .catch(e => {
                console.error(e);
                alert("조회 중 에러가 발생했습니다.");
            });
    }

    function resetSearch() {
        document.getElementById("keyword").value = "";
        document.getElementById("cate1").value = "";
        document.getElementById("minPrice").value = "";
        document.getElementById("maxPrice").value = "";
        document.getElementById("sortSelect").value = "recent";
        search();
    }

    function sortList() {
        applySortAndRender();
    }

    function applySortAndRender() {
        const sort = document.getElementById("sortSelect").value;
        let data = [...currentData];

        if (sort === "priceAsc") {
            data.sort((a, b) => (a.goodsPrice || 0) - (b.goodsPrice || 0));
        } else if (sort === "priceDesc") {
            data.sort((a, b) => (b.goodsPrice || 0) - (a.goodsPrice || 0));
        }

        renderList(data);
    }

    function renderList(list) {
        const wrapper = document.getElementById("resultWrapper");
        const countEl = document.getElementById("resultCount");
        wrapper.innerHTML = "";

        if (!list || list.length === 0) {
            countEl.textContent = "0";
            wrapper.innerHTML = '<div class="empty-msg">검색 결과가 없습니다.</div>';
            return;
        }

        countEl.textContent = list.length.toString();

        list.forEach(item => {
            const div = document.createElement("div");
            div.className = "item-row";

            const title = item.cltrNm || "(이름 없음)";
            const addr = (item.sido || "") + " " + (item.dtlAddr || "");
            const cate = (item.ctgrHirkNm || "기타") + (item.ctgrHirkNmMid ? " · " + item.ctgrHirkNmMid : "");
            const dpsl = item.dpslMtdNm || "";

            div.innerHTML = `
                <div class="thumb">이미지</div>
                <div class="item-main">
                    <div class="title-line">
                        <span class="badge">${dpsl || "공매"}</span>
                        ${title}
                    </div>
                    <div class="sub-line">${cate}</div>
                    <div class="addr-line">${addr}</div>
                    <div class="price-line">
                        감정가 ${numberFormat(item.goodsPrice)}원
                        <span class="sub">관리번호: ${item.cltrMnmtNo || "-"}</span>
                    </div>
                </div>
            `;

            wrapper.appendChild(div);
        });
    }

    window.addEventListener("load", () => search());

</script>

</body>
</html>
